<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Philadelphia, PA - Outbound Train Schedule (Provided by JS & JS)</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- Own CSS -->
    <!-- <link rel="stylesheet" type="text/css" href="assets/css/style.css"> -->

    <!-- Firebase References -->
    <script src="https://www.gstatic.com/firebasejs/6.0.4/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.0.4/firebase-database.js"></script>

</head>

<body>

    <div class="container">

        <!-- Header -->
        <div class="card card-title bg-light pt-4 pb-4 border-warning text-center mt-3">
            <h2>Philadelphia, PA</h2>
            <h6>Outbound Trains to Major East Coast Cities</h6>
        </div>

        <!-- Schedule Container -->
        <div class="card border-warning mb-3">
            <div class="card-header bg-warning">Current Train Schedule</div>
            <div class="card-body text-dark">
                <!-- Table -->
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th scope="col">Carrier Name</th>
                            <th scope="col">Destination</th>
                            <th scope="col">Frequency (Mins)</th>
                            <th scope="col">Next Arrival</th>
                            <th scope="col">Minutes Away</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- <tr>
                            <th scope="row">1</th>
                            <td>Mark</td>
                            <td>Otto</td>
                            <td>@mdo</td>
                            <td>@mdo</td>
                        </tr> -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add Train Container -->
        <div class="card border-warning mb-3">
            <div class="card-header bg-warning">Schedule New Train</div>
            <div class="card-body text-dark">
                <!-- New Train Form -->
                <form>

                    <div class="form-group row">
                        <!-- Label 1 - Train Carrier Name -->
                        <label for="carrier-name" class="col-sm-2 col-form-label">Carrier</label>

                        <!-- Input id = "train-name-input" -->
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="train-name-input">
                        </div>
                    </div>

                    <div class="form-group row">
                        <!-- Label 2 - Destination -->
                        <label for="train-destination" class="col-sm-2 col-form-label">Destination</label>

                        <!-- Input id = "train-destination-input" -->
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="train-destination-input">
                        </div>
                    </div>

                    <div class="form-group row">
                        <!-- Label 3 - First Train Time -->
                        <label for="first-train-time" class="col-sm-2 col-form-label">First Train Time</label>

                        <!-- Input id = "first-train-time-input" -->
                        <div class="col-sm-10">
                            <input type="number" class="form-control" id="first-train-time-input">

                            <!-- Input format Instruction -->
                            <small for="input-format" class="form-text text-muted">HHmm Military format</small>
                        </div>
                    </div>

                    <div class="form-group row">
                        <!-- Label 4 - Frequency -->
                        <label for="train-frequency" class="col-sm-2 col-form-label">Frequency (Mins)</label>

                        <!-- Input id = "train-frequency-input" -->
                        <div class="col-sm-10">
                            <input type="number" class="form-control" id="train-frequency-input">
                        </div>
                    </div>

                    <!-- Submit Form Button -->
                    <button id="submit-button" class="btn btn-warning">Add New</button>

                </form>
            </div>
        </div>

    </div>

    <!-- jQuery link -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- Game.js link -->
    <!-- <script src="assets/javascript/game.js"></script> -->

    <!-- Link to Moment.js  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>

    <script>

        var firebaseConfig = {
            apiKey: "AIzaSyD03ruMPpiPPkzIaN4mEkTuyiTxM3osSdg",
            authDomain: "myfirstappomg.firebaseapp.com",
            databaseURL: "https://myfirstappomg.firebaseio.com",
            projectId: "myfirstappomg",
            storageBucket: "myfirstappomg.appspot.com",
            messagingSenderId: "363745421475",
            appId: "1:363745421475:web:edd3ba776a966809797716"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        var database = firebase.database();
        var connectionsRef = database.ref("/connections");
        var connectedRef = database.ref(".info/connected");

        var employName = "";
        var employRole = "";
        var employStartDate = "";
        var employRate = "";

        $("#submit-button").on("click", function (event) {
            event.preventDefault();
            sendToFirebase();
        });

        function sendToFirebase() {

            // 1 - GET TEXT VALUE FROM INPUT FIELDS
            var newTrainName = $("#train-name-input").val().trim();
            var newTrainDest = $("#train-destination-input").val().trim();
            var firstTrainTime = $("#first-train-time-input").val().trim();
            var frequency = $("#train-frequency-input").val().trim();

            console.log(newTrainName + " to " + newTrainDest);
            console.log("First train at " + firstTrainTime + " then every " + frequency + " mins");

            // FOR FIREBASE
            database.ref().push({
                name: newTrainName,
                destination: newTrainDest,
                firsttime: firstTrainTime,
                frequency: frequency,
                dateAdded: firebase.database.ServerValue.TIMESTAMP
            })
        };

        database.ref().on("child_added", function (snapshot) {
            var sv = snapshot.val();

            console.log("sv.name = " + sv.name);
            console.log("sv.destination = " + sv.destination);
            console.log("sv.firsttime = " + sv.firsttime);
            console.log("sv.frequency = " + sv.frequency + " mins");

            var newTr = $("<tr>");

            var newTdCarrier = $("<td>");
            newTdCarrier.text(sv.name);
            newTr.append(newTdCarrier);

            var newTdDestination = $("<td>");
            newTdDestination.text(sv.destination);
            newTr.append(newTdDestination);

            var newTdFreq = $("<td>");
            newTdFreq.text(sv.frequency);
            newTr.append(newTdFreq);

            ////////////////////

            // Current time converted to military format
            var currentTime = moment();
            console.log("currentTime: " + currentTime.format("HH:mm"));
            console.log("First Train Time from Firebase: " + sv.firsttime);
            console.log("Train Frequency from Firebase: " + sv.frequency);

            // First time (pushed back one year)
            var firstTimeConverted = moment(sv.firsttime, "HHmm").subtract(1, "years");
            console.log("firstTimeConverted: " + firstTimeConverted); 

            // Convert difference of current time and first time to minutes
            var timeDiff = moment().diff(firstTimeConverted, "minutes"); 
            console.log("timeDiff in mins: " + timeDiff); 

            var timeRemainder = timeDiff % sv.frequency; 
            console.log("timeRemainder: " + timeRemainder);

            var minsAway = sv.frequency - timeRemainder;
            console.log("minsAway: " + minsAway); 

            var nextArrival = moment().add(minsAway,"minutes").format("HH:mm");
            console.log("nextArrival: " + nextArrival);

            var newTdNextTrain = $("<td>");
            // newTdNextTrain.text("99:99");
            newTdNextTrain.append(nextArrival);
            newTr.append(newTdNextTrain);

            var newTdMinsAway = $("<td>");
            // newTdMinsAway.text("X Mins");
            newTdMinsAway.append(minsAway + " mins");
            newTr.append(newTdMinsAway);

            $("tbody").append(newTr);

        });

    </script>

</body>

</html>